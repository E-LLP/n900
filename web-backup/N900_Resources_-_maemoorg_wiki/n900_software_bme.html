<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en" dir="ltr" xml:lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

		
				<meta name="keywords" content="N900 Software BME,Mer/Documentation/BME Protocol,N900 Hardware USB Host">
		<link rel="shortcut icon" href="favicon.ico">
		<link rel="search" type="application/opensearchdescription+xml" href="http://wiki.maemo.org/opensearch_desc.php" title="maemo.org wiki (English)">
<link rel="alternate" type="application/rss+xml" title="maemo.org wiki RSS Feed" href="http://wiki.maemo.org/index.php?title=Special:Recentchanges&amp;feed=rss">
<link rel="alternate" type="application/atom+xml" title="maemo.org wiki Atom Feed" href="http://wiki.maemo.org/index.php?title=Special:Recentchanges&amp;feed=atom">
		<title>N900 Software BME - maemo.org wiki</title>
        
        
        <!--[if lte IE 6]>
            <link rel="stylesheet" href="http://static.maemo.org/style_maemo2009/css/ie.css" type="text/css" media="screen">
        <![endif]-->


        
        
		
		
		<meta http-equiv="imagetoolbar" content="no"><!--[endif]---->
		
		
                
		
		<!-- Head Scripts -->
		
		
		
	
<link rel="stylesheet" type="text/css" href="n900_software_bme.css" media="all">
</head>
<body class="mediawiki ns-0 ltr page-N900_Software_BME">
        <div id="container">
            <div id="header">
                <div id="logo">
                                        <a href="http://maemo.org/"><img src="logo.jpg" title="Maemo.org" alt="Maemo.org"></a>
                </div><!-- logo -->

	<div class="portlet" id="p-personal">
		<h5>Personal tools</h5>
		<div class="pBody">
			<ul>
				<li id="pt-login"><a href="http://wiki.maemo.org/index.php?title=Special:Userlogin&amp;returnto=N900_Software_BME" title="You are encouraged to log in, it is not mandatory however. [o]" accesskey="o">Log in / create account</a></li>
			</ul>
		</div>
            </div>
        </div>
            <div id="navigation">
                <div id="navigation-left-wrapper">

                    <div id="navigation-right-wrapper">

                        <ul>
                            <li><a href="http://maemo.org/intro/">Intro</a></li>
                            <li><a href="http://maemo.org/downloads/">Downloads</a></li>
                            <li class="selected"><a href="http://maemo.org/community/">Community</a></li>
                            <li><a href="http://maemo.org/development/">Development</a></li>
                            <li><a href="http://maemo.org/news/">News</a></li>
                            <li><a href="http://talk.maemo.org/">TALK</a></li>
                        </ul>


		<div id="search">
			<form action="http://wiki.maemo.org/Special:Search" id="searchform">
				<input id="searchInput" name="search" title="Search maemo.org wiki [f]" accesskey="f" value="" type="text">
				<input name="go" class="submit" id="searchGoButton" value="Go" title="Go to a page with this exact name if exists" type="submit">&nbsp;
<!--				<input type='submit' name="fulltext" class="submit" id="mw-searchButton" value="Go" title="Search the pages for this text" /> &nbsp; -->
			</form>
		</div>


                    </div>
                </div>
            </div><!-- /navigation -->
            <div id="breadcrumb"></div>
            <div id="content">
                        

<!--	<div id="globalWrapper">
		<div id="column-content">
	<div id="content2"> 


		<a name="top" id="top"></a>
				<h1 class="firstHeading">N900 Software BME</h1>
		<div id="bodyContent">
-->

      
<!-- sidebar --> 
                  <div id="sidebar">
		<div id="nav-sub">

		<div class="portlet" id="p-navigation">
		<h3>Navigation</h3>
			<ul>
				<li id="n-mainpage"><a href="http://wiki.maemo.org/Main_Page" title="Visit the Main Page [z]" accesskey="z">Main Page</a></li>
				<li id="n-recentchanges"><a href="http://wiki.maemo.org/Special:Recentchanges" title="The list of recent changes in the wiki. [r]" accesskey="r">Recent changes</a></li>
				<li id="n-randompage"><a href="http://wiki.maemo.org/Special:Random" title="Load a random page [x]" accesskey="x">Random page</a></li>
				<li id="n-help"><a href="http://wiki.maemo.org/Help:Contents" title="The place to find out.">Help</a></li>
				<li id="n-advancedsearch"><a href="http://wiki.maemo.org/Special:Search">Advanced search</a></li>
			</ul>
	</div>
	


	<div id="p-cactions" class="portlet">
		<h3>Views</h3>
			<ul class="fi_protie_navigation">
					 <li id="ca-nstab-main" class="selected"><a href="http://wiki.maemo.org/N900_Software_BME" title="View the content page [c]" accesskey="c">Page</a></li>
					 <li id="ca-talk" class="new"><a href="http://wiki.maemo.org/index.php?title=Talk:N900_Software_BME&amp;action=edit" title="Discussion about the content page [t]" accesskey="t">Discussion</a></li>
					 <li id="ca-edit"><a href="http://wiki.maemo.org/index.php?title=N900_Software_BME&amp;action=edit" title="You can edit this page. Please use the preview button before saving. [e]" accesskey="e">Edit</a></li>
					 <li id="ca-history"><a href="http://wiki.maemo.org/index.php?title=N900_Software_BME&amp;action=history" title="Past versions of this page. [h]" accesskey="h">History</a></li>
				</ul>
	</div>


    
		</div>

               </div>
<!-- sidebar --> 
<div id="main">
<div id="main-wrapper">

			            <h1 class="firstHeading">N900 Software BME</h1>
			<!-- start content -->
			<p>This page is to bring together efforts and links for those working on understanding BME - the battery managment entity.
</p><p>This is required to implement user friendly <a href="http://wiki.maemo.org/N900_Hardware_USB_Host" title="N900 Hardware USB Host">Host Mode</a>
</p><p>See also the garage project <a href="https://garage.maemo.org/projects/jrbme/" class="external text" title="https://garage.maemo.org/projects/jrbme/" rel="nofollow">JR-BME</a>.
</p><p>BME is divided into three parts.
</p>
<ul><li> Kernel driver that handles all of the low-level interaction with the hardware.
</li><li> hald-addon-bme - an add-on process for HAL that reports status.
</li><li> bme_RX-51 - Process started early in boot, with watchdogs to reboot the device if it malfunctions.
</li></ul>
<p>The kernel driver is split over several files.
</p><p><a href="http://mxr.maemo.org/fremantle/source/kernel/include/linux/i2c/twl4030-madc.h" class="external free" title="http://mxr.maemo.org/fremantle/source/kernel/include/linux/i2c/twl4030-madc.h" rel="nofollow">http://mxr.maemo.org/fremantle/source/kernel/include/linux/i2c/twl4030-madc.h</a>
This handles reading various ADCs to readout voltages, currents and BSI.
</p><p><b>BSI</b>, or battery size indicator is the third pin of the battery. Resistance between the - pin and third pin on battery is measured by BME through twl4030-madc, and mapped into a capacity in mAh. BME noticeably uses this as a reference "full" value for the battery meter, and possibly for other uses as well. Here are some experimental results, all resistance readings are to be considered inaccurate at best:
</p>
<pre>100 k立 1250mAh (Original BL-5J battery)
 90 k立 1000mAh
 80 k立  862mAh
 78 k立  740mAh
</pre>
<p>Unsorted adds:
</p>
<ul><li> Then there's also <code>/usr/lib/hal/hald-addon-bme</code>, which seems not to be completely out of order (according to lshal) even when bme_RX-51 is stopped.
</li><li> Mer 'replacement hald-addon-bme': <a href="http://gitorious.org/mer-toggles/hald-addon-bme/blobs/master/hald-addon-bme.c" class="external free" title="http://gitorious.org/mer-toggles/hald-addon-bme/blobs/master/hald-addon-bme.c" rel="nofollow">http://gitorious.org/mer-toggles/hald-addon-bme/blobs/master/hald-addon-bme.c</a> <a href="http://wiki.maemo.org/Mer/Documentation/BME_Protocol" title="Mer/Documentation/BME Protocol">Mer/Documentation/BME_Protocol</a> (N810!)
</li><li> <code>lsof -p `pidof bme_RX-51`</code> gives an idea about what BME is actually interfering/interfacing with, and a strace will show it talks to dsme_lib probably to implement the watchdog timers.
</li><li> BME process/file is called <code>/usr/sbin/bme_RX-51</code> and killing or sigstop'ing it will cause immediate or delayed reboot. It is easily suspended though through upstart process management by:<br><pre>~&gt;stop bme</pre>and resumed any time by:<br><pre>~&gt;start bme</pre>
</li></ul>
<p>A nice little experiment to investigate the bq24150 USB Battery Charger chip's abilities is to 
</p>
<ul><li> plug in Nokia wallwart charger
</li><li> <pre>-&gt;stop bme</pre>
</li><li> wait max 32s until bq24150 internal watchdog timer expires (due to bme not resetting it), which will cause bq24150 to reset to defaults, which are a mostly sane, safe charging without any software support. You can tell this by bq24150 firing up the hardwired steady yellow indicator LED
</li></ul>
<p>I'm about to write a first draft little script to somewhat replace bme's basic functions, eventually turning this into a real project Just-Replaces-BME aka jrbme (some say it's "JRBME replaces BME", according to an age old tradition of linux self referencing ETLA [like GNU=="GNU Not Unix", KDE=="KDE Desktop Environment"])
</p><p>Joerg's script can be found <a href="http://talk.maemo.org/showpost.php?p=658278&amp;postcount=861" class="external text" title="http://talk.maemo.org/showpost.php?p=658278&amp;postcount=861" rel="nofollow">here</a>.
It should not be used by anyone who has not read and understood all relevant datasheets, and understands why it does what it does.
</p><p>Editing this without understanding can CAUSE YOUR N900 TO CATCH FIRE.
</p>
<table id="toc" class="toc" summary="Contents"><tbody><tr><td><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1"><a href="#Replacement_Goals"><span class="tocnumber">1</span> <span class="toctext">Replacement Goals</span></a>
<ul>
<li class="toclevel-2"><a href="#Alpha"><span class="tocnumber">1.1</span> <span class="toctext">Alpha</span></a></li>
<li class="toclevel-2"><a href="#Beta"><span class="tocnumber">1.2</span> <span class="toctext">Beta</span></a></li>
<li class="toclevel-2"><a href="#Gamma"><span class="tocnumber">1.3</span> <span class="toctext">Gamma</span></a></li>
</ul>
</li>
</ul>
</td></tr></tbody></table>
<a name="Replacement_Goals"></a><h2><span class="editsection">[<a href="http://wiki.maemo.org/index.php?title=N900_Software_BME&amp;action=edit&amp;section=1" title="Edit section: Replacement Goals">edit</a>]</span> <span class="mw-headline">Replacement Goals</span></h2>
<a name="Alpha"></a><h3><span class="editsection">[<a href="http://wiki.maemo.org/index.php?title=N900_Software_BME&amp;action=edit&amp;section=2" title="Edit section: Alpha">edit</a>]</span> <span class="mw-headline">Alpha</span></h3>
<ul><li> Not make the battery explode.
</li><li> Charge from any 5V source, assuming the battery is in a safe condition, just setting the charger chip to the end voltage, and resetting the watchdog.
</li></ul>
<a name="Beta"></a><h3><span class="editsection">[<a href="http://wiki.maemo.org/index.php?title=N900_Software_BME&amp;action=edit&amp;section=3" title="Edit section: Beta">edit</a>]</span> <span class="mw-headline">Beta</span></h3>
<ul><li> Watch the state of the battery, and charge taking into account device load.
<ul><li> Battery charger chip should be configured to float the battery at a current which slightly exceeds the desired float current, and the charge normally terminated when the actual battery current measured by the bq27200 reaches the 'taper' value. A simple way to measure this is if the 'time till full' field goes to 65535. This ensures a consistent shutoff taper current, which the battery charger alone cannot do.
</li></ul>
</li></ul>
<a name="Gamma"></a><h3><span class="editsection">[<a href="http://wiki.maemo.org/index.php?title=N900_Software_BME&amp;action=edit&amp;section=4" title="Edit section: Gamma">edit</a>]</span> <span class="mw-headline">Gamma</span></h3>
<ul><li> Charge at appropriate limits for USB chargers, and USB hosts we are plugged into.
</li><li> Monitor and reset from abnormal conditions - incorrect 'battery missing' and other error codes. Capacity and charge data from bq27200 can be very inaccurate if the phone has not appropriately learned the capacity of the battery, or if it erroneously detects battery full due to a high impedence battery or poor contact.
</li><li> If phone is in active use, and charger or USB is plugged in, maintain a constant battery voltage somewhat under the peak charge voltage, without regards to taper current. (To keep phone charged, but not degrade battery with pointless micro-cycling, or high float voltage)
</li></ul>

<!-- 
NewPP limit report
Preprocessor node count: 19/1000000
Post-expand include size: 0/2097152 bytes
Template argument size: 0/2097152 bytes
#ifexist count: 0/100
-->

<!-- Saved in parser cache with key mediawiki-mw_:pcache:idhash:4078-0!1!0!!en!2 and timestamp 20120705121045 -->
<div class="printfooter">
Retrieved from "<a href="http://wiki.maemo.org/N900_Software_BME">http://wiki.maemo.org/N900_Software_BME</a>"</div>
			<div id="catlinks"><p class="catlinks"><a href="http://wiki.maemo.org/Special:Categories" title="Special:Categories">Category</a>: <span dir="ltr"><a href="http://wiki.maemo.org/Category:N900_Hardware" title="Category:N900 Hardware">N900 Hardware</a></span></p></div>
			<!-- end content -->



                    </div><!-- /main-wrapper -->
                </div><!-- /main --><!-- content end -->

			<div class="visualClear"></div>

        <ul style="clear: left; float: left; display: inline; list-style-type: none;">
<li id="lastmod"> This page was last modified 11:04, 11 February 2011.</li><li id="viewcount">This page has been accessed 7,050 times.</li>      </ul>
			<div class="visualClear"></div>


			<div id="footer">
                <div id="footer-wrapper-left">
                    <div id="footer-wrapper-right">

			<ul>
                                <li class="first"><a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">All Content CC</a></li>
                <li><a href="http://maemo.org/legal/">Legal</a></li>
                				<li class="privacy"><a href="http://wiki.maemo.org/maemo.org_wiki:Privacy_policy" title="maemo.org wiki:Privacy policy">Privacy policy</a></li>
				<li class="about"><a href="http://wiki.maemo.org/maemo.org_wiki:About" title="maemo.org wiki:About">About maemo.org wiki</a></li>
                <li>Powered by <a href="http://www.mediawiki.org/">MediaWiki</a></li>
			</ul>
                    </div>
                </div>
		</div>
		
	
		
</div>
<!-- Served in 0.148 secs. -->

        </div><!-- container -->

    

</body>
</html>
